<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formaviva Request</title>
    <!-- Include the Tailwind CSS CDN -->
    <style>
      body {
        background-color: black;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>

    <script>
      !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
      posthog.init('phc_lSBuwASm1Lz7iAt13tJphLeeUdVNGFC4kg4uuXeG4TA',{api_host:'https://eu.posthog.com'})
    </script>
  </head>

  <template id="npsScore">
    <!-- component -->
    <main class="grid w-full place-items-center mb-10">
      <p class="text-white mb-6">Loading...</p>

      <div class="grid w-full grid-cols-2 mb-2">
        <div class="text-left text-gray-300 text-xs">Least Likely</div>
        <div class="text-right text-gray-300 text-xs">Most Likely</div>
      </div>

      <div
        class="grid w-full wx-[10rem] grid-cols-10 gap-0 rounded-l bg-gray-200 p-1"
      >
        <div>
          <input
            type="radio"
            name="score"
            id="1"
            value="1"
            class="peer hidden"
          />
          <label
            for="1"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >1</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="2"
            value="2"
            class="peer hidden"
          />
          <label
            for="2"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >2</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="3"
            value="3"
            class="peer hidden"
          />
          <label
            for="3"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >3</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="4"
            value="4"
            class="peer hidden"
          />
          <label
            for="4"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >4</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="5"
            value="5"
            class="peer hidden"
          />
          <label
            for="5"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >5</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="6"
            value="6"
            class="peer hidden"
          />
          <label
            for="6"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >6</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="7"
            value="7"
            class="peer hidden"
          />
          <label
            for="7"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >7</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="8"
            value="8"
            class="peer hidden"
          />
          <label
            for="8"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >8</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="9"
            value="9"
            class="peer hidden"
          />
          <label
            for="9"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >9</label
          >
        </div>

        <div>
          <input
            type="radio"
            name="score"
            id="10"
            value="10"
            class="peer hidden"
          />
          <label
            for="10"
            class="block cursor-pointer select-none rounded-l p-2 text-center peer-checked:bg-blue-500 peer-checked:font-bold peer-checked:text-white"
            >10</label
          >
        </div>
      </div>
    </main>
  </template>
  <body class="flex items-center justify-center h-screen">
    <div class="max-w-sm mx-auto">
      <div class="text-center">
        <div class="logo flex justify-center items-center mb-10">
          <a href="https://formaviva.com/?ref+splash">
            <img src="logo.svg" alt="Formaviva" class="w-24" />
          </a>
        </div>

        <div id="userMessage">
          <!-- Display the message -->
          <p class="text-white mb-6">Loading...</p>
          <!-- Button with text and link -->
          <a
            href="#"
            class="px-6 py-2 text-white bg-blue-500 rounded hover:bg-blue-700"
            >Loading...</a
          >
        </div>

        <div id="userInput" class="input" style="display: none">
          <form id="userForm">
            <div id="targetInput"></div>

            <p class="text-white mb-6">Loading...</p>

            <textarea
              name="message"
              id="message"
              rows="4"
              placeholder="Explain your rating"
              class="block w-full rounded-md border-0 px-3.5 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-inset my-5"
            ></textarea>

            <button
              type="submit"
              class="px-6 py-2 text-white bg-blue-500 rounded hover:bg-blue-700"
            >
              Loading...
            </button>

            <!-- Error message div -->
            <div
              id="errorMessage"
              class="mt-4 text-red-500 hidden"
              style="display: none"
            ></div>
          </form>
        </div>
      </div>
    </div>

    <script>
      /*
there are two modes:
1. message with button
2. feedback input with message
*/
      function getAllQueryParams() {
        const params = new URLSearchParams(window.location.search);
        let queryParams = {};

        for (let [key, value] of params.entries()) {
          queryParams[key] = value;
        }

        return queryParams;
      }

      function appendQueryParamsToUrl(baseUrl, params) {
        // Create a new URL object
        const url = new URL(baseUrl);

        // Iterate over the params hash and set each key-value pair in the URL's search parameters
        for (let key in params) {
          url.searchParams.set(key, params[key]);
        }

        // Return the updated URL as a string
        return url.toString();
      }

      function renderTemplate(templateId, targetId) {
        const template = document.getElementById(templateId).content;
        const clone = document.importNode(template, true);
        document.getElementById(targetId).appendChild(clone);
      }

      $(document).ready(function () {
        const identifier = new URLSearchParams(window.location.search).get(
          "id"
        );

        if (!identifier || !/^[a-zA-Z0-9-_]+$/.test(identifier)) {
          console.error("Invalid identifier provided.");
          return;
        }

        // Fetch the JSON data from your endpoint
        // const endpoint = 'https://splash.nightwatch.io';
        // const endpoint = "http://localhost:8002";
        const endpoint = "";

        $.getJSON(endpoint + "ids.json", function (data) {
          if (data[identifier]) {
            window.splash = data[identifier];

            init(data[identifier]);
          } else {
            console.error("Identifier not found in the data.");
          }
        }).fail(function (jqxhr, textStatus, error) {
          console.error("Error fetching data:", error);
        });
      });

      function init(splash) {
        document.title = splash.message;
        $("#userMessage p").text(splash.message);

        const $button = $("#userMessage a");
        $button.text(splash.buttonText);
        $button.attr("href", splash.buttonLink);

        if (splash.input) {
          $("#userMessage").hide();
          $("#userInput").show();

          $("#userInput p").text(splash.inputMessage);
          const $inputButton = $("#userInput button");
          $inputButton.text(splash.inputButtonText);

          if (splash.inputType === "nps") {
            renderTemplate("npsScore", "targetInput");

            $("#targetInput p").text(splash.npsQuestion);

            const queryParams = getAllQueryParams();
            if (queryParams["score"]) {
              $(`input[name="score"][value="${queryParams["score"]}"]`).prop(
                "checked",
                true
              );
            }
          }

          $("#userForm").submit(function (e) {
            // Check if the score is set in NPS mode
            if (
              splash.inputType === "nps" &&
              !$("input[name='score']:checked").val()
            ) {
              // Show validation error
              $("#errorMessage").text("Please select a score.").show();
            } else {
              // append query params to the submit url
              const queryParams = getAllQueryParams();
              const submitUrl = appendQueryParamsToUrl(
                splash.inputSubmitUrl,
                queryParams
              );

              $.ajax({
                type: "POST",
                url: submitUrl,
                data: $(this).serialize(),
                success: function (response) {
                  // Here you handle what to do when submission is successful.
                  $("#userInput").hide();
                  $("#userMessage").show();
                },
                error: function (error) {
                  // Handle errors here, maybe alert the user?
                  console.log(error);
                  $("#errorMessage").text("Could not submit the feedback - please get in touch.").show();
                },
              });
            }

            // Prevent form submission
            e.preventDefault();
          });
        }
      }
    </script>
  </body>
</html>
